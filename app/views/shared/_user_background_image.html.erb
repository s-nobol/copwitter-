
<div class="background_image_form text-center " > 
    <%= form_for(@user,url: update_image_path , method: :post) do |f| %>
          <div class="text-center " id="img_field" onClick="$('#file').click()" >
              
              <!--// 画像があるときは画像を表示する-->
              <% if @user.background_image.present? %>
                <%= image_tag(@user.background_image.url , class:"w-100 h-100", ) %>
              <% else %>
                <h1 class="img-fluid pt-5">プロフィール画像</h1>
                <i class="fas fa-image mt-4" style="font-size:130px;" id="icon"></i>
              <% end %>
            
            
              <!--スピナー-->
               <div class="pt-4 bg-light" style="display: none;" role="status" id="spinner">
                <span class="spinner-border text-secondary" ></span>
              </div>
          </div>
            
          <!--ファイルフォーム-->
          <%= f.file_field :background_image ,class: "image", style: "display:none;", id: "file" %>
          <div class="update-button">
            <%= f.submit "アップロード", class: "btn btn-primary ", id:"upload-btn" %> 
          </div>
     
    <% end %>
</div>
<!--トリミングjQuery-->
  <!-- CSS -->
<link  href="//cdnjs.cloudflare.com/ajax/libs/cropper/3.1.6/cropper.min.css" rel="stylesheet">
<!-- JS -->
<script src="//cdnjs.cloudflare.com/ajax/libs/cropper/3.1.6/cropper.min.js"></script>


<!--【画像アップロード】file_fieldデザイン変更＋画像選択時にプレビュー表示する方法-->
<script>
  $(function(){
    
    $fileField = $('#file')
    var spinner = document.getElementById('spinner')
    var icon = document.getElementById('icon')

          // ビジーwaitを使う
          function sleep(waitMsec) {
            var startMsec = new Date();
            while (new Date() - startMsec < waitMsec);
          }

          // 選択された画像を取得し表示
          $($fileField).on('change', $fileField, function(e) {
          file = e.target.files[0]
            // if (file.size/1024/1024 > 5) {
            //   alert('Maximum file size is 5MB. Please choose a smaller file.');
            // }
          
          reader = new FileReader(),
          $preview = $("#img_field");
          
          // 読み込み開始
          reader.onloadstart = (function () { 
          icon.style.display="none";
          spinner.style.display="block";
          console.log('画像読み込み状態', reader.readyState); 
          });
              
               
          // 読み込み中
          reader.onload = (function(file) {
            return function(e) {
              $preview.empty();
              sleep(300);
              $preview.append($('<img>').attr({
                src: e.target.result,
                width: "100%",
                height: "100%",
                class: "crop_image",
                title: file.name
              }));
            };
          })(file);
              
          // 読み込み終了
        reader.onloadend = function () { 
            spinner.style.display="none";
            icon.style.display="block";
            console.log('画像読み込み状態', reader.readyState); 
    
            // クラッパー起動
            // var $image = $('.crop_image');
            // $image.css('overflow', 'hidden')
            // $image.cropper({
            //         viewMode:0,
            //         dragMode:"move",
            //         aspectRatio:13/5,
            //         wheelZoomRatio:0.05,
            //         modal:false,
            //         autoCropArea:1,
            //         cropBoxMovable:false,
            //         cropBoxResizable:false,
            //         dragCrop:false,
            //         toggleDragModeOnDblclick:false,
            //         built:function(){
            //             $(".crop_image").cropper(
            //                 "setCropBoxData",{left:50,top:40.5,width:1000,height:300}
            //             );
            //         }
            // });
        };
      reader.readAsDataURL(file);
    });
    
    

  });
</script>